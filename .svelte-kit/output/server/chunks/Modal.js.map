{"version":3,"file":"Modal.js","sources":["../../../../src/lib/components/common/Modal.svelte"],"sourcesContent":["<script lang=\"ts\">\n\timport { onDestroy, onMount } from 'svelte';\n\timport { fade } from 'svelte/transition';\n\timport { flyAndScale } from '$lib/utils/transitions';\n\n\texport let show = true;\n\texport let size = 'md';\n\texport let containerClassName = 'p-3';\n\texport let className = 'bg-gray-50 dark:bg-gray-900 rounded-2xl';\n\texport let draggable = false; // 是否可拖动\n\texport let minimizable = false; // 新增: 是否可最小化\n\texport let title = ''; // 新增: 窗口标题，用于最小化时显示\n\n\tlet modalElement = null;\n\tlet modalContentElement = null;\n\tlet mounted = false;\n\tlet minimized = false; // 新增: 是否已最小化\n\tlet minimizedPosition = { x: 20, y: 20 }; // 新增: 最小化后的位置\n\n\t// 拖动相关状态\n\tlet isDragging = false;\n\tlet initialX = 0;\n\tlet initialY = 0;\n\tlet currentX = 0;\n\tlet currentY = 0;\n\tlet offsetX = 0;\n\tlet offsetY = 0;\n\n\t// 最小化图标拖动状态\n\tlet isMinimizedDragging = false;\n\tlet minInitialX = 0;\n\tlet minInitialY = 0;\n\n\tconst sizeToWidth = (size) => {\n\t\tif (size === 'full') {\n\t\t\treturn 'w-full';\n\t\t}\n\t\tif (size === 'xs') {\n\t\t\treturn 'w-[16rem]';\n\t\t} else if (size === 'sm') {\n\t\t\treturn 'w-[30rem]';\n\t\t} else if (size === 'md') {\n\t\t\treturn 'w-[42rem]';\n\t\t} else {\n\t\t\treturn 'w-[56rem]';\n\t\t}\n\t};\n\n\tconst handleKeyDown = (event: KeyboardEvent) => {\n\t\tif (event.key === 'Escape' && isTopModal() && !minimized) {\n\t\t\tconsole.log('Escape');\n\t\t\tshow = false;\n\t\t}\n\t};\n\n\tconst isTopModal = () => {\n\t\tconst modals = document.getElementsByClassName('modal');\n\t\treturn modals.length && modals[modals.length - 1] === modalElement;\n\t};\n\n\t// 新增: 切换最小化状态\n\tfunction toggleMinimize() {\n\t\tminimized = !minimized;\n\t\t\n\t\t// 如果从最小化恢复，重置窗口位置\n\t\tif (!minimized) {\n\t\t\tresetPosition();\n\t\t}\n\t}\n\n\t// 开始拖动\n\tfunction startDrag(e) {\n\t\tif (!draggable || !modalContentElement || minimized) return;\n\n\t\t// 检查是否在标题区域点击（前30px高度区域）\n\t\tconst rect = modalContentElement.getBoundingClientRect();\n\t\tconst mouseY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;\n\t\t\n\t\tif (mouseY - rect.top > 30) {\n\t\t\t// 如果不是在顶部区域点击，不启动拖动\n\t\t\treturn;\n\t\t}\n\n\t\t// 防止选择文本\n\t\te.preventDefault();\n\t\tisDragging = true;\n\n\t\t// 获取鼠标或触摸起始位置\n\t\tif (e.type === 'mousedown') {\n\t\t\tinitialX = e.clientX;\n\t\t\tinitialY = e.clientY;\n\t\t} else if (e.type === 'touchstart') {\n\t\t\tinitialX = e.touches[0].clientX;\n\t\t\tinitialY = e.touches[0].clientY;\n\t\t}\n\n\t\t// 当前偏移量\n\t\tcurrentX = offsetX;\n\t\tcurrentY = offsetY;\n\n\t\t// 添加移动和结束事件监听\n\t\tdocument.addEventListener('mousemove', drag);\n\t\tdocument.addEventListener('touchmove', drag, { passive: false });\n\t\tdocument.addEventListener('mouseup', stopDrag);\n\t\tdocument.addEventListener('touchend', stopDrag);\n\t}\n\n\t// 拖动过程\n\tfunction drag(e) {\n\t\tif (!isDragging) return;\n\n\t\te.preventDefault();\n\n\t\tlet clientX, clientY;\n\n\t\tif (e.type === 'mousemove') {\n\t\t\tclientX = e.clientX;\n\t\t\tclientY = e.clientY;\n\t\t} else if (e.type === 'touchmove') {\n\t\t\tclientX = e.touches[0].clientX;\n\t\t\tclientY = e.touches[0].clientY;\n\t\t}\n\n\t\t// 计算新位置\n\t\tconst dx = clientX - initialX;\n\t\tconst dy = clientY - initialY;\n\n\t\toffsetX = currentX + dx;\n\t\toffsetY = currentY + dy;\n\n\t\t// 应用位置\n\t\tif (modalContentElement) {\n\t\t\tmodalContentElement.style.transform = `translate(${offsetX}px, ${offsetY}px)`;\n\t\t}\n\t}\n\n\t// 停止拖动\n\tfunction stopDrag() {\n\t\tisDragging = false;\n\n\t\t// 移除事件监听\n\t\tdocument.removeEventListener('mousemove', drag);\n\t\tdocument.removeEventListener('touchmove', drag);\n\t\tdocument.removeEventListener('mouseup', stopDrag);\n\t\tdocument.removeEventListener('touchend', stopDrag);\n\t}\n\n\t// 新增: 开始拖动最小化图标\n\tfunction startMinimizedDrag(e) {\n\t\te.preventDefault();\n\t\tisMinimizedDragging = true;\n\n\t\t// 获取鼠标或触摸起始位置\n\t\tif (e.type === 'mousedown') {\n\t\t\tminInitialX = e.clientX - minimizedPosition.x;\n\t\t\tminInitialY = e.clientY - minimizedPosition.y;\n\t\t} else if (e.type === 'touchstart') {\n\t\t\tminInitialX = e.touches[0].clientX - minimizedPosition.x;\n\t\t\tminInitialY = e.touches[0].clientY - minimizedPosition.y;\n\t\t}\n\n\t\t// 添加移动和结束事件监听\n\t\tdocument.addEventListener('mousemove', dragMinimized);\n\t\tdocument.addEventListener('touchmove', dragMinimized, { passive: false });\n\t\tdocument.addEventListener('mouseup', stopMinimizedDrag);\n\t\tdocument.addEventListener('touchend', stopMinimizedDrag);\n\t}\n\n\t// 新增: 拖动最小化图标\n\tfunction dragMinimized(e) {\n\t\tif (!isMinimizedDragging) return;\n\n\t\te.preventDefault();\n\n\t\tlet clientX, clientY;\n\n\t\tif (e.type === 'mousemove') {\n\t\t\tclientX = e.clientX;\n\t\t\tclientY = e.clientY;\n\t\t} else if (e.type === 'touchmove') {\n\t\t\tclientX = e.touches[0].clientX;\n\t\t\tclientY = e.touches[0].clientY;\n\t\t}\n\n\t\t// 计算并设置新位置\n\t\tminimizedPosition.x = clientX - minInitialX;\n\t\tminimizedPosition.y = clientY - minInitialY;\n\n\t\t// 确保不超出屏幕\n\t\tconst screenWidth = window.innerWidth;\n\t\tconst screenHeight = window.innerHeight;\n\t\tminimizedPosition.x = Math.max(0, Math.min(minimizedPosition.x, screenWidth - 60));\n\t\tminimizedPosition.y = Math.max(0, Math.min(minimizedPosition.y, screenHeight - 60));\n\t}\n\n\t// 新增: 停止拖动最小化图标\n\tfunction stopMinimizedDrag() {\n\t\tisMinimizedDragging = false;\n\n\t\t// 移除事件监听\n\t\tdocument.removeEventListener('mousemove', dragMinimized);\n\t\tdocument.removeEventListener('touchmove', dragMinimized);\n\t\tdocument.removeEventListener('mouseup', stopMinimizedDrag);\n\t\tdocument.removeEventListener('touchend', stopMinimizedDrag);\n\t}\n\n\t// 重置位置\n\tfunction resetPosition() {\n\t\toffsetX = 0;\n\t\toffsetY = 0;\n\t\tif (modalContentElement) {\n\t\t\tmodalContentElement.style.transform = '';\n\t\t}\n\t}\n\n\t// 当模态窗口关闭时，重置状态\n\t$: if (!show) {\n\t\tresetPosition();\n\t\tminimized = false;\n\t}\n\n\tonMount(() => {\n\t\tmounted = true;\n\t});\n\n\t$: if (show && modalElement) {\n\t\tdocument.body.appendChild(modalElement);\n\t\twindow.addEventListener('keydown', handleKeyDown);\n\t\tdocument.body.style.overflow = 'hidden';\n\t} else if (modalElement) {\n\t\twindow.removeEventListener('keydown', handleKeyDown);\n\t\tdocument.body.removeChild(modalElement);\n\t\tdocument.body.style.overflow = 'unset';\n\t}\n\n\tonDestroy(() => {\n\t\tshow = false;\n\t\tif (modalElement) {\n\t\t\tdocument.body.removeChild(modalElement);\n\t\t}\n\n\t\t// 确保清理所有事件监听器\n\t\tdocument.removeEventListener('mousemove', drag);\n\t\tdocument.removeEventListener('touchmove', drag);\n\t\tdocument.removeEventListener('mouseup', stopDrag);\n\t\tdocument.removeEventListener('touchend', stopDrag);\n\t\tdocument.removeEventListener('mousemove', dragMinimized);\n\t\tdocument.removeEventListener('touchmove', dragMinimized);\n\t\tdocument.removeEventListener('mouseup', stopMinimizedDrag);\n\t\tdocument.removeEventListener('touchend', stopMinimizedDrag);\n\t});\n</script>\n\n{#if show}\n\t<!-- svelte-ignore a11y-click-events-have-key-events -->\n\t<!-- svelte-ignore a11y-no-static-element-interactions -->\n\t<div\n\t\tbind:this={modalElement}\n\t\tclass=\"modal fixed top-0 right-0 left-0 bottom-0 {minimized ? 'pointer-events-none' : 'bg-black/60'} w-full h-screen max-h-[100dvh] {containerClassName} flex justify-center z-9999 overflow-y-auto overscroll-contain\"\n\t\tin:fade={{ duration: 10 }}\n\t\ton:mousedown={() => {\n\t\t\tif (!isDragging && !minimized) {\n\t\t\t\tshow = false;\n\t\t\t}\n\t\t}}\n\t>\n\t\t<!-- 主窗口 - 仅在非最小化状态显示 -->\n\t\t{#if !minimized}\n\t\t\t<div\n\t\t\t\tbind:this={modalContentElement}\n\t\t\t\tclass=\"m-auto max-w-full {sizeToWidth(size)} {size !== 'full' ? 'mx-2' : ''} shadow-3xl min-h-fit scrollbar-hidden {className} {draggable ? 'cursor-move' : ''}\"\n\t\t\t\tstyle={draggable ? 'position: relative;' : ''}\n\t\t\t\tin:flyAndScale\n\t\t\t\ton:mousedown={(e) => {\n\t\t\t\t\te.stopPropagation();\n\t\t\t\t\tif (draggable) {\n\t\t\t\t\t\tstartDrag(e);\n\t\t\t\t\t}\n\t\t\t\t}}\n\t\t\t\ton:touchstart={(e) => {\n\t\t\t\t\te.stopPropagation();\n\t\t\t\t\tif (draggable) {\n\t\t\t\t\t\tstartDrag(e);\n\t\t\t\t\t}\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<!-- 标题栏 -->\n\t\t\t\t{#if draggable}\n\t\t\t\t\t<div class=\"absolute top-0 w-full h-8 cursor-move flex items-center justify-between px-2\">\n\t\t\t\t\t\t{#if minimizable}\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tclass=\"h-5 w-5 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300\"\n\t\t\t\t\t\t\t\ton:click|stopPropagation={toggleMinimize}\n\t\t\t\t\t\t\t\ttitle=\"Minimize\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<span class=\"block w-3 h-0.5 bg-current\"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t{/if}\n\t\t\t\t\t</div>\n\t\t\t\t{/if}\n\t\t\t\t\n\t\t\t\t<slot />\n\t\t\t</div>\n\t\t{/if}\n\n\t\t<!-- 最小化图标 - 仅在最小化状态显示 -->\n\t\t{#if minimized}\n\t\t\t<!-- svelte-ignore a11y-click-events-have-key-events -->\n\t\t\t<!-- svelte-ignore a11y-no-static-element-interactions -->\n\t\t\t<div\n\t\t\t\tclass=\"fixed pointer-events-auto bg-blue-500 text-white shadow-lg rounded-full w-12 h-12 flex items-center justify-center cursor-move\"\n\t\t\t\tstyle=\"left: {minimizedPosition.x}px; top: {minimizedPosition.y}px;\"\n\t\t\t\ton:mousedown={startMinimizedDrag}\n\t\t\t\ton:touchstart={startMinimizedDrag}\n\t\t\t\ton:dblclick={toggleMinimize}\n\t\t\t>\n\t\t\t\t<div class=\"w-full h-full rounded-full flex items-center justify-center hover:bg-blue-600\">\n\t\t\t\t\t<span class=\"text-xs font-medium\">{title.slice(0, 2).toUpperCase()}</span>\n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t<!-- 悬浮时显示完整标题的工具提示 -->\n\t\t\t\t<div class=\"absolute left-full ml-2 py-1 px-2 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none\">\n\t\t\t\t\t{title || 'Window'}\n\t\t\t\t\t<div class=\"absolute right-full top-1/2 transform -translate-y-1/2 border-4 border-transparent border-r-gray-800\"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t{/if}\n\t</div>\n{/if}\n\n<style>\n\t.modal-content {\n\t\tanimation: scaleUp 0.1s ease-out forwards;\n\t}\n\n\t@keyframes scaleUp {\n\t\tfrom {\n\t\t\ttransform: scale(0.985);\n\t\t\topacity: 0;\n\t\t}\n\t\tto {\n\t\t\ttransform: scale(1);\n\t\t\topacity: 1;\n\t\t}\n\t}\n</style>"],"names":["size"],"mappings":"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"}