import{s as W,e as g,k as T,c as y,a as C,d as p,o as k,f as w,i as E,g as d,u as Z,n as B,I as x,T as G,t as D,b as N,h as A,D as H,E as M,M as V}from"../chunks/Dc4_ziGv.js";import{S as X,i as Y,b as ee,d as te,m as se,t as re,a as ne,e as le}from"../chunks/CAZSMy3J.js";import{w as oe}from"../chunks/03rUxzUZ.js";const P=oe({inProgress:!1,progress:0,error:null,result:null});async function ae(){try{const s=await fetch("/api/data");if(!s.ok)throw new Error(`获取数据失败: ${s.status}`);return await s.json()}catch(s){throw console.error("获取数据失败:",s),new Error(`获取数据失败: ${s.message}`)}}function ie(s){const e={data:{supporting_tables:{},master_table:null,timestamp:new Date().toISOString()}};return s.supportingTables&&Object.entries(s.supportingTables).forEach(([t,n])=>{e.data.supporting_tables[t]={data:n.data,columns:n.columns||n.data[0],columnTypes:q(n.data),rowCount:n.data.length,encoding:"utf-8"}}),s.masterTable&&(e.data.master_table={data:s.masterTable.data,columns:s.masterTable.columns||s.masterTable.data[0],columnTypes:q(s.masterTable.data),rowCount:s.masterTable.data.length}),e}function q(s){if(!s||s.length<2)return{};const e={},t=s[0],n=/^(?:\d{4}[-/]\d{2}[-/]\d{2}|\d{2}[-/]\d{2}[-/]\d{4})$/;return t.forEach((l,r)=>{const i=String(l||"");if(i.toLowerCase().includes("date")){e[i]="DATE";return}const c=s.slice(1),o=c.find(f=>f&&f[r]&&String(f[r]).trim()!=="");if(o){const f=String(o[r]).trim();if(n.test(f)){e[i]="DATE";return}}let h=!0,m=!1;for(const f of c){if(!f||f.length<=r)continue;const a=f[r];if(a&&String(a).trim()!==""){const u=String(a).replace(/,/g,"");if(isNaN(Number(u))){h=!1;break}u.includes(".")&&(m=!0)}}h?e[i]=m?"DECIMAL":"INTEGER":e[i]="VARCHAR"}),e}async function ce(s){try{const e=await fetch("/api/sync",{method:"POST",headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json","Accept-Language":"zh-CN"},body:JSON.stringify(s)});if(!e.ok){const t=await e.json();throw new Error(t.error||`服务器错误 (${e.status})`)}return await e.json()}catch(e){throw console.error("同步数据失败:",e),e}}async function ue(){P.update(s=>({...s,inProgress:!0,progress:0,error:null,result:null}));try{P.update(n=>({...n,progress:10}));const s=await ae();P.update(n=>({...n,progress:40}));const e=ie(s);P.update(n=>({...n,progress:70}));const t=await ce(e);return P.update(n=>({...n,progress:100,result:t})),t}catch(s){throw P.update(e=>({...e,error:s.message})),s}finally{P.update(s=>({...s,inProgress:!1}))}}function fe(s){let e,t,n;return{c(){e=H("svg"),t=H("path"),n=D(`
        同步数据`),this.h()},l(l){e=M(l,"svg",{viewBox:!0,class:!0});var r=C(e);t=M(r,"path",{d:!0}),C(t).forEach(p),r.forEach(p),n=N(l,`
        同步数据`),this.h()},h(){w(t,"d","M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46c.78-1.23 1.24-2.69 1.24-4.26 0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"),w(e,"viewBox","0 0 24 24"),w(e,"class","sync-icon svelte-1h5y1i")},m(l,r){E(l,e,r),d(e,t),E(l,n,r)},d(l){l&&(p(e),p(n))}}}function pe(s){let e,t;return{c(){e=g("span"),t=D("同步中..."),this.h()},l(n){e=y(n,"SPAN",{class:!0}),C(e).forEach(p),t=N(n,"同步中..."),this.h()},h(){w(e,"class","spinner svelte-1h5y1i")},m(n,l){E(n,e,l),E(n,t,l)},d(n){n&&(p(e),p(t))}}}function J(s){let e,t;return{c(){e=g("div"),t=g("div"),this.h()},l(n){e=y(n,"DIV",{class:!0});var l=C(e);t=y(l,"DIV",{class:!0,style:!0}),C(t).forEach(p),l.forEach(p),this.h()},h(){w(t,"class","progress-fill svelte-1h5y1i"),G(t,"width",s[1].progress+"%"),w(e,"class","progress-bar svelte-1h5y1i")},m(n,l){E(n,e,l),d(e,t)},p(n,l){l&2&&G(t,"width",n[1].progress+"%")},d(n){n&&p(e)}}}function U(s){let e,t=s[1].error+"",n;return{c(){e=g("div"),n=D(t),this.h()},l(l){e=y(l,"DIV",{class:!0});var r=C(e);n=N(r,t),r.forEach(p),this.h()},h(){w(e,"class","error-message svelte-1h5y1i")},m(l,r){E(l,e,r),d(e,n)},p(l,r){r&2&&t!==(t=l[1].error+"")&&A(n,t)},d(l){l&&p(e)}}}function he(s){let e,t,n,l,r,i;function c(a,u){return a[0]?pe:fe}let o=c(s),h=o(s),m=s[1].inProgress&&J(s),f=s[1].error&&U(s);return{c(){e=g("div"),t=g("button"),h.c(),n=T(),m&&m.c(),l=T(),f&&f.c(),this.h()},l(a){e=y(a,"DIV",{class:!0});var u=C(e);t=y(u,"BUTTON",{class:!0});var _=C(t);h.l(_),_.forEach(p),n=k(u),m&&m.l(u),l=k(u),f&&f.l(u),u.forEach(p),this.h()},h(){w(t,"class","sync-button svelte-1h5y1i"),t.disabled=s[0],w(e,"class","sync-container svelte-1h5y1i")},m(a,u){E(a,e,u),d(e,t),h.m(t,null),d(e,n),m&&m.m(e,null),d(e,l),f&&f.m(e,null),r||(i=Z(t,"click",s[2]),r=!0)},p(a,[u]){o!==(o=c(a))&&(h.d(1),h=o(a),h&&(h.c(),h.m(t,null))),u&1&&(t.disabled=a[0]),a[1].inProgress?m?m.p(a,u):(m=J(a),m.c(),m.m(e,l)):m&&(m.d(1),m=null),a[1].error?f?f.p(a,u):(f=U(a),f.c(),f.m(e,null)):f&&(f.d(1),f=null)},i:B,o:B,d(a){a&&p(e),h.d(),m&&m.d(),f&&f.d(),r=!1,i()}}}function de(s,e,t){const n=x();let l=!1,r={inProgress:!1,success:!1,error:null,progress:0};async function i(){try{t(1,r.inProgress=!0,r),t(1,r.progress=10,r),t(0,l=!0);const c=await ue();t(1,r.progress=100,r),t(1,r.success=!0,r),n("synccomplete",c)}catch(c){t(1,r.error=c.message,r),n("syncerror",{error:c})}finally{t(1,r.inProgress=!1,r),t(0,l=!1)}}return[l,r,i]}class me extends X{constructor(e){super(),Y(this,e,de,he,W,{})}}function F(s){let e,t,n="同步成功",l,r,i=s[0].summary&&K(s);return{c(){e=g("div"),t=g("h3"),t.textContent=n,l=T(),r=g("div"),i&&i.c(),this.h()},l(c){e=y(c,"DIV",{class:!0});var o=C(e);t=y(o,"H3",{class:!0,"data-svelte-h":!0}),V(t)!=="svelte-u0tu82"&&(t.textContent=n),l=k(o),r=y(o,"DIV",{class:!0});var h=C(r);i&&i.l(h),h.forEach(p),o.forEach(p),this.h()},h(){w(t,"class","svelte-289zo3"),w(r,"class","result-summary svelte-289zo3"),w(e,"class","result-panel svelte-289zo3")},m(c,o){E(c,e,o),d(e,t),d(e,l),d(e,r),i&&i.m(r,null)},p(c,o){c[0].summary?i?i.p(c,o):(i=K(c),i.c(),i.m(r,null)):i&&(i.d(1),i=null)},d(c){c&&p(e),i&&i.d()}}}function K(s){let e,t,n="表格总数:",l,r=(s[0].summary.tableCount||0)+"",i,c,o,h,m="行数:",f,a=(s[0].summary.rowCount||0)+"",u,_,v,z,L="同步时间:",j,R=new Date(s[0].timestamp).toLocaleString()+"",O;return{c(){e=g("p"),t=g("strong"),t.textContent=n,l=T(),i=D(r),c=T(),o=g("p"),h=g("strong"),h.textContent=m,f=T(),u=D(a),_=T(),v=g("p"),z=g("strong"),z.textContent=L,j=T(),O=D(R)},l(b){e=y(b,"P",{});var S=C(e);t=y(S,"STRONG",{"data-svelte-h":!0}),V(t)!=="svelte-7tn0rf"&&(t.textContent=n),l=k(S),i=N(S,r),S.forEach(p),c=k(b),o=y(b,"P",{});var I=C(o);h=y(I,"STRONG",{"data-svelte-h":!0}),V(h)!=="svelte-1wu19gw"&&(h.textContent=m),f=k(I),u=N(I,a),I.forEach(p),_=k(b),v=y(b,"P",{});var $=C(v);z=y($,"STRONG",{"data-svelte-h":!0}),V(z)!=="svelte-1r9ycu9"&&(z.textContent=L),j=k($),O=N($,R),$.forEach(p)},m(b,S){E(b,e,S),d(e,t),d(e,l),d(e,i),E(b,c,S),E(b,o,S),d(o,h),d(o,f),d(o,u),E(b,_,S),E(b,v,S),d(v,z),d(v,j),d(v,O)},p(b,S){S&1&&r!==(r=(b[0].summary.tableCount||0)+"")&&A(i,r),S&1&&a!==(a=(b[0].summary.rowCount||0)+"")&&A(u,a),S&1&&R!==(R=new Date(b[0].timestamp).toLocaleString()+"")&&A(O,R)},d(b){b&&(p(e),p(c),p(o),p(_),p(v))}}}function Q(s){let e,t,n="同步失败",l,r,i;return{c(){e=g("div"),t=g("h3"),t.textContent=n,l=T(),r=g("p"),i=D(s[1]),this.h()},l(c){e=y(c,"DIV",{class:!0});var o=C(e);t=y(o,"H3",{class:!0,"data-svelte-h":!0}),V(t)!=="svelte-40qgjl"&&(t.textContent=n),l=k(o),r=y(o,"P",{});var h=C(r);i=N(h,s[1]),h.forEach(p),o.forEach(p),this.h()},h(){w(t,"class","svelte-289zo3"),w(e,"class","error-panel svelte-289zo3")},m(c,o){E(c,e,o),d(e,t),d(e,l),d(e,r),d(r,i)},p(c,o){o&2&&A(i,c[1])},d(c){c&&p(e)}}}function _e(s){let e,t,n="数据同步",l,r,i="将您的数据同步到后端系统",c,o,h,m,f;o=new me({}),o.$on("synccomplete",s[2]),o.$on("syncerror",s[3]);let a=s[0]&&F(s),u=s[1]&&Q(s);return{c(){e=g("section"),t=g("h2"),t.textContent=n,l=T(),r=g("p"),r.textContent=i,c=T(),ee(o.$$.fragment),h=T(),a&&a.c(),m=T(),u&&u.c(),this.h()},l(_){e=y(_,"SECTION",{class:!0});var v=C(e);t=y(v,"H2",{"data-svelte-h":!0}),V(t)!=="svelte-1v8xu4j"&&(t.textContent=n),l=k(v),r=y(v,"P",{"data-svelte-h":!0}),V(r)!=="svelte-1a5bwtk"&&(r.textContent=i),c=k(v),te(o.$$.fragment,v),h=k(v),a&&a.l(v),m=k(v),u&&u.l(v),v.forEach(p),this.h()},h(){w(e,"class","sync-section svelte-289zo3")},m(_,v){E(_,e,v),d(e,t),d(e,l),d(e,r),d(e,c),se(o,e,null),d(e,h),a&&a.m(e,null),d(e,m),u&&u.m(e,null),f=!0},p(_,[v]){_[0]?a?a.p(_,v):(a=F(_),a.c(),a.m(e,m)):a&&(a.d(1),a=null),_[1]?u?u.p(_,v):(u=Q(_),u.c(),u.m(e,null)):u&&(u.d(1),u=null)},i(_){f||(re(o.$$.fragment,_),f=!0)},o(_){ne(o.$$.fragment,_),f=!1},d(_){_&&p(e),le(o),a&&a.d(),u&&u.d()}}}function ve(s,e,t){let n=null,l=null;function r(c){t(0,n=c.detail),t(1,l=null)}function i(c){t(1,l=c.detail.error),t(0,n=null)}return[n,l,r,i]}class Ce extends X{constructor(e){super(),Y(this,e,ve,_e,W,{})}}export{Ce as component};
//# sourceMappingURL=42.Bv0tQXrn.js.map
